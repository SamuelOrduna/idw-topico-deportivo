{% extends "base.html" %}
{% block title %}Calendario | Arena Glory{% endblock %}
{% block tab_calendar_active %}active{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="bg-body-tertiary rounded-4 p-3 border border-secondary mb-4">
    <div class="btn-group" role="group" aria-label="Navegación">
      <a href="/" class="btn btn-outline-secondary">Eventos</a>
      <a href="/estadisticas" class="btn btn-outline-secondary">Estadísticas</a>
      <a href="/calendario" class="btn btn-outline-secondary active">Calendario</a>
    </div>
  </div>

  <div class="card bg-body text-body border-secondary rounded-4">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row gap-3 align-items-start align-items-md-end">
        <div>
          <label class="form-label">Selecciona fecha</label>
          <input id="calDate" type="date" class="form-control" />
        </div>
        <button id="btnCalFilter" class="btn btn-primary">
          <i class="bi bi-calendar-event me-1"></i>Ver eventos del día
        </button>
        <button id="btnCalClear" class="btn btn-outline-secondary">Limpiar</button>
      </div>

      <hr />
      <div id="calList" class="vstack gap-2"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const API = window.API_BASE || "http://127.0.0.1:8000";
  const $ = (s) => document.querySelector(s);

  async function safeFetch(url, opts = {}) {
    const r = await fetch(url, opts);
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  }

  async function filterCalendar() {
    const val = $("#calDate").value;
    const list = $("#calList");
    if (!val) {
      list.innerHTML = `<div class="text-secondary">Selecciona una fecha.</div>`;
      return;
    }
    try {
      const events = await safeFetch(`${API}/events?page=1&page_size=100`);
      const matches = events.filter((e) => (e.fecha_iso || "").slice(0, 10) === val);
      list.innerHTML =
        matches
          .map(
            (e) => `
          <div class="border rounded p-2 d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">${e.titulo}</div>
              <div class="small text-secondary">${e.local} vs ${e.visita} · ${e.liga}</div>
              <div class="small"><i class="bi bi-clock me-1"></i>${new Date(
                e.fecha_iso
              ).toLocaleString()}</div>
            </div>
          </div>`
          )
          .join("") || `<div class="text-secondary">Sin eventos ese día.</div>`;
    } catch (err) {
      list.innerHTML = `<div class="text-danger small">Error cargando eventos.</div>`;
      console.error(err);
    }
  }

  $("#btnCalFilter").addEventListener("click", filterCalendar);
  $("#btnCalClear").addEventListener("click", () => {
    $("#calDate").value = "";
    $("#calList").innerHTML = "";
  });
  $("#calDate").addEventListener("change", filterCalendar);
</script>
{% endblock %}
